name: Build Safe OCR Tool

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Get Date
        id: date
        run: echo "TODAY=$(date +'%Y.%m.%d')" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 【安全升级 1】改用 standalone (文件夹) 模式，极大降低报毒率
      - name: Build with Nuitka (Safe Mode)
        uses: Nuitka/Nuitka-Action@main
        with:
          # 请确保您的代码文件真的叫这个名字！
          script-name: video_ocr.py
          # 使用 standalone 生成一个包含所有依赖的文件夹，而不是单文件病毒行为
          mode: standalone
          enable-plugins: tk-inter
          disable-console: true
          # 伪装成正经软件的元数据
          company-name: "Local Studio"
          product-name: "Video Subtitle Extractor"
          file-version: "1.0.0.0"

      # 【安全升级 2】把生成的安全文件夹打包成 ZIP
      - name: Zip the output
        run: |
          # Nuitka standalone 会生成 video_ocr.dist 文件夹
          Compress-Archive -Path build/video_ocr.dist/* -DestinationPath Video_OCR_Extractor_v${{ env.TODAY }}.zip

      # 3. 发布这个 ZIP 包
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: github.event_name != 'pull_request'
        with:
          files: "*.zip"
          tag_name: v${{ env.TODAY }}-${{ github.run_number }}
          name: "Video Subtitle Extractor [${{ env.TODAY }}]"
          body: |
            已转换为安全模式架构 (Standalone)。
            不再使用高风险的单文件打包机制，可有效避免企业级杀毒软件误报。
            
            使用方法：下载 ZIP -> 解压到一个文件夹 -> 双击里面的 video_ocr.exe 运行。
