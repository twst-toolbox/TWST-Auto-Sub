name: Build Safe OCR Tool

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Get Date
        id: date
        run: echo "TODAY=$(date +'%Y.%m.%d')" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 1. 打包 (安全模式)
      - name: Build with Nuitka (Safe Mode)
        uses: Nuitka/Nuitka-Action@main
        with:
          # 【关键修正】这里必须和您仓库里的文件名一模一样！
          script-name: video_ocr.py
          
          # 使用 standalone 模式 (生成文件夹，而非单文件病毒行为)
          mode: standalone
          enable-plugins: tk-inter
          disable-console: true
          company-name: "Local Studio"
          product-name: "Video Subtitle Extractor"
          file-version: "1.0.0.0"

      # 2. 压缩 (把生成的文件夹打包成 ZIP)
      - name: Zip the output
        run: |
          # Nuitka 在 standalone 模式下会生成一个 .dist 文件夹
          # 文件夹名字通常是 "脚本名.dist"，所以这里是 video_ocr.dist
          Compress-Archive -Path build/video_ocr.dist -DestinationPath Video_OCR_Extractor_v${{ env.TODAY }}.zip

      # 3. 发布
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: github.event_name != 'pull_request'
        with:
          files: "*.zip"
          tag_name: v${{ env.TODAY }}-${{ github.run_number }}
          name: "Video Subtitle Extractor [${{ env.TODAY }}]"
          body: |
            ✅ 安全版构建 (Standalone Mode)
            
            使用方法：
            1. 下载 ZIP 并解压。
            2. 进入解压后的文件夹 (video_ocr.dist)。
            3. 找到 video_ocr.exe 双击运行。
